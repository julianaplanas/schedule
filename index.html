<script>
    const calendar = document.querySelector("#calendar");
    const dropdown = document.querySelector("#nameDropdown");
    const monthTitle = document.querySelector("#monthTitle");

    let shiftsData = {};

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            console.log("Fetching shifts...");
            const response = await fetch("https://schedule-jx24.onrender.com/shifts"); // Replace with your backend URL
            if (!response.ok) {
                throw new Error(`Failed to fetch shifts: ${response.status}`);
            }

            const data = await response.json();
            console.log("Received data:", data);

            const { month, dayNumbers, shifts } = data;

            // Validate and update shifts
            if (!Array.isArray(shifts) || shifts.length === 0) {
                throw new Error("No valid shift data received.");
            }
            if (!Array.isArray(dayNumbers) || dayNumbers.length === 0) {
                throw new Error("No valid day numbers received.");
            }

            monthTitle.textContent = `Mes: ${month}`; // Update the month title
            shiftsData = { shifts, days: dayNumbers }; // Store shifts and days for later use
            populateDropdown();
        } catch (error) {
            console.error("Error loading preloaded shifts:", error);
            alert("Failed to load schedule data. Please try again later.");
        }
    });

    function populateDropdown() {
        dropdown.innerHTML = '<option value="">Seleccion√° un nombre</option>';
        shiftsData.shifts.forEach(shift => {
            const option = document.createElement("option");
            option.value = shift.name;
            option.textContent = shift.name;
            dropdown.appendChild(option);
        });
    }

    function populateCalendar(selectedDays, dayNumbers) {
        calendar.innerHTML = ""; // Clear existing calendar

        const daysOfWeek = ["L", "M", "X", "J", "V", "S", "D"];
        daysOfWeek.forEach(day => {
            const headerDiv = document.createElement("div");
            headerDiv.className = "day header";
            headerDiv.textContent = day;
            calendar.appendChild(headerDiv);
        });

        for (let i = 0; i < dayNumbers.length; i++) {
            const dayDiv = document.createElement("div");
            dayDiv.className = `day ${getShiftClass(selectedDays[i])}`;
            const shiftText = selectedDays[i] ? `(${selectedDays[i]})` : "";
            dayDiv.textContent = `${dayNumbers[i]} ${shiftText}`; // Display day number and shift type
            calendar.appendChild(dayDiv);
        }
    }

    dropdown.addEventListener("change", (e) => {
        const selectedName = e.target.value;
        const selectedShift = shiftsData.shifts.find(shift => shift.name === selectedName);

        if (selectedShift) {
            populateCalendar(selectedShift.days, shiftsData.days);
        } else {
            calendar.innerHTML = "<p>No shifts found for this name.</p>";
        }
    });

    function getShiftClass(shift) {
        if (["RM", "M1", "M2", "M3", "M5"].includes(shift)) return "morning";
        if (["S", "P2", "P3", "P4", "P5"].includes(shift)) return "cut";
        if (["RT", "T1", "T2", "T3", "T5"].includes(shift)) return "night";
        return "off";
    }
</script>
